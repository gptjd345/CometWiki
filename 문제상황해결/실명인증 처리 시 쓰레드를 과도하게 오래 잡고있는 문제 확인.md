사건발단: 2023년 8월 4일과 10월 4일 엘리바이저에 특정 요청에 대해 쓰레드를 과도하게 오래잡고있는 쓰레드가 굉장히 많이 발견되었음.
앨리바이저에서 찍어주는 쓰레드 덤프확인 결과 내국인 실명인증 요청 처리하는 과정에 문제가 있는 것을 확인하였음. 
해당 요청은 보통 길어도 건당 10초 이내로 끝나는데 191분까지 잡고있는 상에서 확인하였음.

에러 원인 파악 및 확인 과정
팩트
1. 민원24의 실명확인 서비스를 사용하고있고 민원24 측에서 제공하는 샘플코드를 수정해서 사용하고있다. 
2. ldap 객체를 생성하고 ldap.getData()메소드를 호출하게끔 구성되어있는데 디컴파일러로 확인해본결과 구현내용이 native method 로 구현되어있었고 이에대해 민원24측에 메소드 세부 구현내용이나, 네트워크 지연발생 시 해당 메소드에서 쓰레드를 과도하게 오래 잡을 여지가 있는지 문의 했으나 그런거 없다고 답변받음. 
3. 실명확인은 AP 와 실명인증서버간의 통신 이후 결과값만 리턴하게 끔 되어있어서 별도의 DB 트랜잭션은 없다. 
4. AP 단에서 실명인증 서버로 요청 보내기전 Relay 해주는 모듈이 있는데 해당 모듈과 통신할때 URLConnection을 사용한다. 
가설
네트워크 지연에 의한 영향을 예상한건 사건 발생 일을 제외한 나머지 날에는 위같은 문제가 발생하지 않았음. 
URLConnetion은 ReadTimeout(데이터를 읽어들일 때 끊기는 경우 다음 데이터를 읽어들때까지 기다리는 시간) 과 ConnectionTimeout (상대방과 연결에 성공할때까지 걸리는 시간)을 설정할 수 있지만 connection을 통해 데이터를 주고받는 총시간에 대한 제어는 불가능하다. 따라서 ReadTimeout 에 의해 종료되지 않게 많은 양의 데이터를 천천히 전달하면 쓰레드가 오래 점유되도록 하여 문제 상황과 유사한 상황을 만들 수 있을거라고 생각했다. 

가설증명
데이터를 천천히 전달하는 httpserver 모듈을 만들기로 했다.

<h3>수신부</h3>
~~~java
public class SlowDataServer {
	public static void main(String[] args) throws Exception{
	//int port = findAvailablePort(); 사용가능한 임의의 포트를 받음
	/*
	 * 사설 포트 범위에서 하나 골라서 사용함.   
	 * netstat -tuln | grep 포트번호(tcp/udp 프로토콜을 사용하는 리스닝 상태의 포트조회) /         * sudo lsof -i : 포트번호 (사용중인 포트면 다 보여줌)
	 */
	int port = 55555; 
	HttpServer server = HttpServer.create(new InetSocketAddress(port),0);
	server.createContext(“/juminCheckTest.ajax”,new MyHandler());
	ExecutorService executor = Executors.newFixedThreadPool(5);
	server.setExecutor(executor);
	server.start();
	
	System.out.println(“server is running on port: “ + port);
	
	}

	static class Myhandler implements HttpHandler {
		@Override
		public void handle(HttpExchange t) throws IOException {
			String response = String.join(“”,Collections.nCopies(180,”This is the             response”));
			t.sendResponseHeader(200, response.length());
			System.out.println(“response length : “+response.length());
			OutputStream os = t.getResponseBody();
			for(char ch : response.toCharArray()) {
				os.write(ch);
				os.flush();
				try{
					//1초 쉬고 진행 
					Thread.sleep(1000);
				}
				catch(InterruptException e){
					Thread.currentThread().inturrupt();
					throw new IOException(e);
				}
			}
			os.close();
		
		}

	}

	private static int findAvailablePort() throws IOException {
		try(ServerSocket socket = new ServerSocket(0))
			return socket.getLocalPort();
	}

}


~~~

<h3>송신부(일부)</h3>
```java
url = new URL(“http://localhost:55555/juminCheckTest.ajax”);
urlconn = url.openConnection();
urlconn.setReadTimeout(30000);
urlconn.setConnectionTimeout(30000);
urlconn.DoOutput(true);

in new BufferedReader(new InputStreamReader(urlconn.getInputStream()));

String line;
while((line = in.readLine()) != null){
 LOGGER.info(“#### {} #####\n\n”,line);
}


```

테스트 방안 및 예상 결과 
실명인증 정상 처리시 전달하는 문자열의 길이가 3~4000바이트 정도 되기 때문에 그만한 문자열을 생성하여 1글자 보낼때마다 1초씩 기다리므로 180*18 = 3240 총 60분 소요될것으로 예상되며 실제 계속 물고있는 현상을 확인하였음. 
결과 : urlconnection 은 네트워크 지연으로 인해 데이터가 천천히 지속적으로 보내진다면 연결이 끝어지지않으며 해당 로직을 처리하는 쓰레드는 계속 반환되지 않고 점유된 상태 그대로 유지한다. 

해결방안 
만약 민원24측 말대로 gpki 라이브러리 관련 작업에서 네트워크 지연으로 인한 문제가 발생하지 않는다는게 사실이라면 , 실명인증 처리하는 쓰레드를 별도로 생성하여 관리하고 전체 수행 가능 시간을 정해서 처리하도록 구성하기로 함.   AP <-> Relay <-> 실명인증서버  
Relay 서버는 통신시 tcp 소켓을 열어통신한다. 
AP 단에서 urlconnection 대신 최대 수행시간을 지정할 수 있는 httpClient 를 사용하려면 Relay 쪽모듈(솔루션)도 수정해야하는 상황이다. tcp 소켓통신 방식으로 바꿀경우 AP 단에서 처리가 가능하나 소스가 복잡해진다. 일단 행정안전부 주민과에 httpClient 로 통신하도록 하는 가이드가 존재하는지 확인요청 보냈음.
행정안전부 주민과에서는 ldap 쪽에 연락해보라고하고 urlconnection 으로 연결하는 것에 대한 문제도 뭔말인지 모르는거같고 맘에 안들면 안드는 기관에서 수정해서 쓰라고 함. 




	@Async 어노테이션을 사용하는 경우
	스프링에서 내부적으로 TaskExecutor 인터페이스를 사용한다. 
	이 인터페이스의 구현체 중 하나인 ThreadPoolTaskExecutor는 쓰레드 풀을 사용하여 비동기 작업을 처리한다. 
	별도의 쓰레드를 직접관리하는대신 @Async어노테이션과 ThreadPoolTaskExecutor라는 구현체를 사용하여 비동기 처리를 구현하는것이 권장된다. 
	직접관리할 필요없으므로 코드가 간결해지고 쓰레드 풀을 이용한 효율적인 리소스관리가 가능하다? 
```java
@Configuration
@EnableAsync
public class AsyncConfig implements AsyncConfigurer {

 @Override
 public Executor getAsyncExecutor() {
 
 }

 @Override
 public AsyncUncaughtExceptionHandler getAsyncUncaughtExceptionHandler() {
 
 }

}


```